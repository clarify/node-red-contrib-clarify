<script type="text/javascript">
    const noValue = {
        value: "none",
        label: "None",
        hasValue: false
    }
    RED.nodes.registerType("ensure-signal", {
        category: "Clarify",
        color: "#00FF75",
        defaults: {
            name: { value: "" },
            apiRef: { value: null, type: "clarify-api" },
            createItem: { value: false, required: true },
            dataType: { value: "integration.EnsureFloat64Signal", required: true },
            sourceType: { value: "measurement", required: true },
            signalID: {
                value: "",
                required: false,
                validate: RED.validators.typedInput('signalIDType')
            },
            signalIDType: { value: "autoGenerated" },
            itemID: { value: "" },
            signalName: {
                value: "signalName",
                required: true,
                validate: RED.validators.typedInput('signalNameType')
            },
            signalNameType: { value: "msg" },
            signalEngUnit: {
                value: "none",
                required: false,
                validate: RED.validators.typedInput('signalEngUnitType')
            },
            signalEngUnitType: { value: "none" },
            signalLabels: {
                value: "signalLabels",
                required: false,
                validate: RED.validators.typedInput('signalLabelsType')
            },
            signalLabelsType: { value: "none" },
            enumValues: {
                value: "enumValues",
                required: false,
                validate: RED.validators.typedInput('enumValuesType')
            },
            enumValuesType: { value: "msg" },
            signalLocations: {
                value: "signalLocations",
                required: false,
                validate: RED.validators.typedInput('signalLocationsType')
            },
            signalLocationsType: { value: "none" },
        },

        inputs: 1,
        outputs: 1,
        icon: "clarify.png",
        label: function () {
            return this.name || "ensure signal";
        },
        oneditprepare: function () {
            $('#node-input-dataType').on('change', function (event) {
                if (event.currentTarget.value === "integration.EnsureEnumSignal") {
                    $('#enum-values-container').show()
                    $('#engUnit-container').hide()
                } else {
                    $('#enum-values-container').hide()
                    $('#engUnit-container').show()
                }
            })
            $('#node-input-enumValues').typedInput({
                default: this.enumValuesType || 'msg',
                types: ['json', 'msg'],
            });
            $('#node-input-signalName').typedInput({
                default: this.signalNameType || 'msg',
                types: ['str', 'msg']
            });
            $('#node-input-signalEngUnit').typedInput({
                default: this.signalEngUnitType || 'none',
                types: [noValue, 'str', 'msg']
            });
            $('#node-input-signalLabels').typedInput({
                default: this.signalLabelsType || 'none',
                types: [noValue, 'json', 'msg']
            });
            $('#node-input-signalLocations').typedInput({
                default: this.signalLocationsType || 'none',
                types: [noValue, 'json', 'msg']
            });
            $('#node-input-signalID').typedInput({
                default: this.signalIDType || 'msg',
                types: ['msg', {
                    value: "str",
                    label: "string",
                    icon: "red/images/typedInput/az.png",
                    validate: /^[a-z0-9_]{1,40}$|^[0-9a-v]{20}_[a-z0-9_]{1,40}$/
                }, {
                        value: "autoGenerated",
                        label: "Auto Generated",
                        icon: "red/images/typedInput/bool.png",
                        hasValue: false
                    }]
            });

            $.getJSON('signalID/', { id: this.id }, function (data) {
                if (data.signalID) {
                    $('#node-input-dataType').attr('disabled', true)
                    $('#node-input-signalID').typedInput('type', 'str')
                    $('#node-input-signalID').typedInput('value', data.signalID)
                    $('#node-input-signalID').typedInput().next().find('input').attr('disabled', true)
                    $('#node-input-signalID').typedInput().next().find('button').attr('disabled', true)
                }
            });

            $.getJSON('itemID/', { id: this.id }, function (data) {
                if (data.itemID) {
                    $('#node-input-itemID').val(data.itemID)
                    $('#node-input-createItem').attr('disabled', true);
                }
            });


        },
        oneditsave: function () {
            this.signalIDType = $("#node-input-signalID").typedInput('type');
            this.signalNameType = $("#node-input-signalName").typedInput('type');
            this.signalEngUnitType = $("#node-input-signalEngUnit").typedInput('type');
            this.signalLabelsType = $("#node-input-signalLabels").typedInput('type');
            this.enumValuesType = $("#node-input-enumValues").typedInput('type');
            this.signalLocationsType = $("#node-input-signalLocations").typedInput('type');
        }
    });
</script>
<style>
    .red-ui-editor .form-row {
        white-space: nowrap;
    }

    .red-ui-editor .form-row label {
        white-space: nowrap;
    }
</style>

<script type="text/html" data-template-name="ensure-signal">
    <div class="form-row">
        <label for="node-input-name">Display Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-apiRef">API</label>
        <input type="text" id="node-input-apiRef" placeholder="API Endpoint">
    </div>
    <hr align="middle">
    <div class="form-row">
        <label for="node-input-createItem">Create Item</label>
        <input type="checkbox" id="node-input-createItem" value="1">
    </div>
    <div class="form-row">
        <label for="node-input-sourceType">Source type</label>
        <select type="text" id="node-input-sourceType">
            <option value="measurement">Measurement</option>
            <option value="prediction">Prediction</option>
         </select>
    </div>
    <div class="form-row">
        <label for="node-input-dataType">Data type</label>
        <select type="text" id="node-input-dataType">
            <option value="integration.EnsureFloat64Signal">Float</option>
            <option value="integration.EnsureEnumSignal">Enum</option>
         </select>
    </div>
    <div class="form-row">
        <label for="node-input-signalName">Name</label>
        <input type="text" id="node-input-signalName">
    </div>
    <div class="form-row" id="enum-values-container">
        <label for="node-input-enumValues">Enum Values</label>
        <input type="text" id="node-input-enumValues">
    </div>
    <div class="form-row" id="engUnit-container">
        <label for="node-input-signalEngUnit">Engineering Unit</label>
        <input type="text" id="node-input-signalEngUnit">
    </div>
    <div class="form-row">
        <label for="node-input-signalID">ID</label>
        <input type="text" id="node-input-signalID" style="width:70%">
    </div>
    <div class="form-row">
        <label for="node-input-itemID">Item ID</label>
        <input type="text" id="node-input-itemID" style="width:70%" disabled>
    </div>
    <div class="form-row">
        <label for="node-input-signalLabels">Labels</label>
        <input type="text" id="node-input-signalLabels">
    </div>
    <div class="form-row">
        <label for="node-input-signalLocations">Locations</label>
        <input type="text" id="node-input-signalLocations">
    </div>
</script>

<script type="text/html" data-help-name="ensure-signal">
    <p>Create Clarify Signal and optional related Item</p>

    <h3>Details</h3>
    <p>Use this node to create a signal (and item) in Clarify. Any changes to the details after creation will update the parameters on the signal and item.</p>

    <h3>General Properties</h3>
    <dl class="message-properties">
        <dt>API <span class="property-type">config</span></dt>
        <dd>API Configuration</dd>

        <dt class="optional">Create Item <span class="property-type">boolean</span></dt>
        <dd>Automatically create related Item.</dd>

        <dt class="optional">Source type <span class="property-type">string</span></dt>
        <dd>Signal source type.</dd>
        <dd><code>Measurement:</code> Historical or real-time data</dd>
        <dd><code>Prediction:</code> Future data</dd>

        <dt class="optional">Data type <span class="property-type">string</span></dt>
        <dd>Signal data type.</dd>
        <dd><code>Enum:</code> Enumerical values</dd>
        <dd><code>Float:</code> Floating point values</dd>
    </dl>

    <h3>Inputs</h3>
        <dl class="message-properties">
            <dt>Name <span class="property-type">msg | string</span></dt>
            <dd>Signal name.</dd>
            <dd>Expects: string value</dd>

            <dt class="optional">Enum Values <span class="property-type">msg | string</span></dt>
            <dd>Enum values.</dd>
            <dd>Expects: Map[number]string.</dd>
            <dd>Example: <code>{"0":"Open","1":"Closed"}</code></dd>

            <dt class="optional">Labels <span class="property-type">msg | string</span></dt>
            <dd>Signal labels.</dd>
            <dd>Expects: Map[string]string[].</dd>
            <dd>Example: <code>{"equipment":["fan","engine"]}</code></dd>

            <dt class="optional">Locations <span class="property-type">msg | string</span></dt>
            <dd>Signal locations.</dd>
            <dd>Expects: string[].</dd>
            <dd>Example: <code>["Office","H101"]</code></dd>
        </dl>
    
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>signalID <span class="property-type">string</span></dt>
        <dd>This node will add the ID of the created signal (and item) to the incoming message and pass it through. It can therefore be used before an add data node to ensure that the signal is created before adding data.</dd>
    </dl>
    
    <h3>References</h3>
        <p>
            <a href="#">Clarify Documentation</a>
        </p>
</script>